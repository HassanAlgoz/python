# التعبير النمطي

تستعمل التعبيرات النمطية لاستخراج البيانات من النصوص.
على سبيل المثال، هذا سجل تمارين فيه في كل سطر نوع من أنواع التمارين وعدد الجلسات ومرات التكرار، لكنها غير مرتبة.
فأحيانًا يكون الاسم في البداية، وأحيانا في الأخير ... وهكذا.

```python
text = """
Pushups 30 reps 3 sets
5 reps 2 sets Pullups
2 Sets 15 Reps One-leg Squats
4 sets 8 reps 22.5 lbs Dumbbell Rows
4 sets 8 reps 15.25kg Dumbbell Rows
"""
```

**التعبير النمطي** (Regular Expression): طريقة لتحديد نمط متسلسل من الأحرف. والغرض منه: البحث عن هذا النمط في نص ما.
وله في بايثون مكتبتان:

- مكتبة [`re`](https://docs.python.org/3/library/re.html) المبنية
- مكتبة [`regex`](https://pypi.org/project/regex/) الخارجية والتي تدعم الترميز العالمي (Unicode) المهم للغة العربية.

```{python}
import re
```

**الأحرف الخاصة** (meta-characters): هي أحرف ذات دلالة معيَّنة غير ما تبدو؛ وهي:

```
. ^ $ * + ? { } [ ] \ | ( )
```

## فئة الأحرف

سنبدأ أولاً بشرح محدد **فئة الأحرف** `[ ]` (Character Class) ويعمل كالآتي:

- `[abc]` يطابق a أو b أو c
- `[^abc]` يطابق أي حرف غير a أو b أو c
- `[a-c]` يطابق أي حرف من a إلى c: `a` أو `b` أو `c`
- `[3-7]` يطابق أي رقم من 3 إلى 7: `3` أو `4` أو `5` أو `6` أو `7`
- `[a-zA-Z]` يطابق أي حرف صغير أو كبير من a إلى z أو A إلى Z
- `[a-zA-Z0-9_]` يطابق أي حرف صغير أو كبير أو رقم من a إلى z أو A إلى Z أو 0 إلى 9 أو `_` (الشرطة السفلية)

وبهذا تعرف دلالة:

- علامة `^` في نحو: `[^` تدل على عكس الفئة
- علامة `-` في نحو: `[a-b]` تدل على الأحرف بين الحرفين (شاملة لهما)

تأمل المثال التالي:

```{python}
text = "I am 21 years old"
pattern = "[0-9][0-9]"
match = re.search(pattern, text)
print(match)
```

- لاحظ أن النمط: `[0-9][0-9]` يطابق أي رقمين متتاليين من 0 إلى 9.
- ويأتي الإجراء [`re.search`](https://docs.python.org/3/library/re.html#search-vs-match) للبحث داخل النص `text` عن النمط `pattern`؛ ونوع العائد هو [`Match`](https://docs.python.org/3/library/re.html#match-objects) إذا وُجد وإلا يكون `None`.

ولاستخراج النص المطابق نستعمل الفعل `match.group()` هكذا:

```{python}
if match:
    print(match.group())
```

## فئات لها رمز

ينضم إلى الأحرف الآنف ذكرها:

<dl>
<dt>`\d` وعكسها `\D`</dt>
<dd>يطابق أي رقم عشري؛ وهو مكافئ: `[0-9]`.</dd>

<dt>`\w` وعكسها `\W`</dt>
<dd>يطابق الأحرف الأبجدية والأرقام والشرطة السفلية `[a-zA-Z0-9_]`.</dd>

<dt>`\s` وعكسها `\S`</dt>
<dd>يطابق المسافات البيضاء؛ وهو مكافئ: `[ \t\n\r\f\v]` (لاحظ وجود المسافة).</dd>
</dl>

ولأن بايثون تعتبر علامة `\` في النصوص علامةً على أحرف خاصة ([Escape Character](http://docs.python.org/3/reference/lexical_analysis.html#escape-sequences)) مثل:

- `\n` للسطر الجديد
- `\t` للمسافة البيضاء
- `\r` للرجوع إلى البداية
- `\f` للصفحة
- `\v` للمسافة العمودية 

ولتجنب التعارض بين حرف `\` المقصود في النص البايثوني المعروف، والاختصارات التي نريدها؛ فقد وضعت بايثون حرف `r` لتعطيل خصوصية الحرف `\` حتى تُكتَب الأنماط النصية بمى يسمى النص الخام (raw string) على النحو التالي:

```{python}
text = "I am 21 years old"
pattern = r"\d\d"
match = re.search(pattern, text)
if match:
    print(match.group())
```

**نصيحة**: استعمل `r` دائمًا عند كتابة الأنماط النصية.

وأما لمطابقة الحروف فإننا قد نستعمل الاختصار `\w` على النحو التالي:

```{python}
animals = [
    "cat",
    "bat",
    "dog",
    "rat",
]

pattern = r"\wa\w"

for animal in animals:
    match = re.search(pattern, animal)
    if match:
        print(match.group())
```

- لاحظ أن النمط `\wa\w` يتكون من ثلاثة أجزاء:
    - `\w` تطابق الأحرف الأبجدية والأرقام والشرطة السفلية
    - `a` تطابق الحرف `a` كما هو
    - `\w` تطابق الأحرف الأبجدية والأرقام والشرطة السفلية
- وبذلك يصير النمط مطابقًا لأي حرفين يتوسطهما حرف `a` مثل: `cat` أو `bat` أو `rat`. والخارج من هذا النمط هو كلمة: `dog`

## التكرار والتحديد

تستعمل علامات التكرار / **المحددات الكمية** (Quantifiers) لتعيين مرات التكرار من النمط السابق. وهي على النحو التالي:

- `{3}` ثلاث مرات بالضبط
- `{2,4}` من 2 إلى 4 مرات
- `{3,}` ثلاث مرات أو أكثر
- `+` مرة أو أكثر
- `*` صفر أو أكثر
- `?` صفر أو مرة واحدة فقط

ولتحديد مجموعة من الأحرف ضمن النمط نستعمل القوسين الدائريين: `( )` حول النمط ليكون **مجموعة مطابقة** ([Match Group](https://docs.python.org/3/howto/regex.html#grouping)).

مثلاً، تريد مطابقة السعر في النصوص التالية:

```{python}
prices = [
    "it costs 123",
    "I bought it for 12.3 last time",
    "I paid 12.34 SAR for it"
]
```

فتستعمل المنط التالي:

```{python}
pattern = r"\d+(\.\d+)?"
```

ويتكون من ثلاثة أجزاء:

- `\d+` ويتكون من جزئين:
    - `\d` رقم
    - `+` مرة أو أكثر
- `(...)?` ما بين القوسين: صفر أو مرة واحدة فقط
    - `\.` نحتاج علامة `\` لتعطيل خصوصية حرف النقطة لأنها تدل على مطابقة أي حرف
    - `\d+` رقم، مرة أو أكثر

```{python}
for p in prices:
    match = re.search(pattern, p)
    if match:
        print('price:', match.group())
```

## تحرير التعبيرات النمطية

ننصح باستعمال أدوات **تحرير التعبير النمطي** مثل: [regex101](https://regex101.com/) فهي أفضل بكثير من كتابته دون أداة.

- في القائمة الجانبية اختر نكهة (Flavour) **Python**
- في الحقل الأول تكتب التعبير النمطي
- في الصندوق الكبير تضع النص الذي تريد مطابقته

وكذلك يوجد محرر آخر مثل [regexr](https://regexr.com/) وفي القائمة الجانبية تجد **Community Patterns** حيث تجد فهرس لأنماط نصية شاركها المبرمجون الآخرون.

وهكذا فإنك تعدل على النمط وتزيد في النصوص، حتى تصل إلى أفضل نمط لتنسخه وتضع في برنامجك.

## مصادر أخرى للتعلم

دروس تفاعلية لتعلم التعبيرات النمطية:

- [RegexLearn](https://regexlearn.com/)
- [RegexOne](https://regexone.com/)
